<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Admin • Spooky Street Map</title>
<link rel="stylesheet" href="https://unpkg.com/mini.css@3.0.1/dist/mini-default.min.css">
<style>body{max-width:1100px;margin:20px auto} textarea, input{width:100%} .muted{opacity:.75}</style>
</head>
<body>
<header><h1>Admin</h1><p class="muted">Edit/Delete, Export/Import, and Area Summary</p></header>

<section>
  <button id="refresh">🔄 Refresh</button>
  <button id="export">⬇️ Export JSON</button>
  <label style="display:inline-block;margin-left:8px">
    ⬆️ Import JSON <input type="file" id="import" accept="application/json" style="display:inline-block">
  </label>
</section>

<section>
  <h3>Addresses</h3>
  <table id="tbl">
    <thead><tr><th>Name</th><th>Address</th><th>Postcode</th><th>Notes</th><th>Flags</th><th>Lat</th><th>Lng</th><th></th></tr></thead>
    <tbody></tbody>
  </table>
</section>

<section>
  <h3>Area Summary (by outward code)</h3>
  <pre id="summary" style="background:#f6f8fa;padding:12px;border-radius:8px"></pre>
</section>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL = "https://gstufixpbltnarnhrwcb.supabase.co";
const SUPABASE_ANON_KEY = "<your anon key>";
const TABLE = "homes";
const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
let rows = [];

async function load(){
  const { data, error } = await supa.from(TABLE).select('*').order('updated_at',{ascending:false});
  if (error){ alert('Load failed'); return; }
  rows = data || [];
  renderTable();
  renderSummary();
}
function renderTable(){
  const tb = document.querySelector('#tbl tbody');
  tb.innerHTML = '';
  rows.forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input value="${esc(r.name||'')}" data-id="${r.id}" data-k="name"></td>
      <td><input value="${esc(r.address||'')}" data-id="${r.id}" data-k="address"></td>
      <td><input value="${esc(r.postcode||'')}" data-id="${r.id}" data-k="postcode"></td>
      <td><input value="${esc(r.notes||'')}" data-id="${r.id}" data-k="notes"></td>
      <td>
        <label><input type="checkbox" ${r.teal?'checked':''} data-id="${r.id}" data-k="teal"> teal</label>
        <label><input type="checkbox" ${r.lights?'checked':''} data-id="${r.id}" data-k="lights"> lights</label>
        <label><input type="checkbox" ${r.music?'checked':''} data-id="${r.id}" data-k="music"> music</label>
        <label><input type="checkbox" ${r.animatronics?'checked':''} data-id="${r.id}" data-k="animatronics"> animatronics</label>
      </td>
      <td><input type="number" step="any" value="${r.lat??''}" data-id="${r.id}" data-k="lat" style="width:110px"></td>
      <td><input type="number" step="any" value="${r.lng??''}" data-id="${r.id}" data-k="lng" style="width:110px"></td>
      <td><button data-id="${r.id}" class="save">💾</button> <button data-id="${r.id}" class="del">🗑️</button></td>
    `;
    tb.appendChild(tr);
  });

  tb.querySelectorAll('.save').forEach(b=>b.addEventListener('click', async ()=>{
    const id = b.dataset.id;
    const patch = collectPatch(id);
    patch.updated_at = new Date().toISOString();
    const { error } = await supa.from(TABLE).update(patch).eq('id', id);
    if (error) return alert('Save failed');
    await load();
  }));
  tb.querySelectorAll('.del').forEach(b=>b.addEventListener('click', async ()=>{
    const id = b.dataset.id;
    if (!confirm('Delete this address?')) return;
    const { error } = await supa.from(TABLE).delete().eq('id', id);
    if (error) return alert('Delete failed');
    await load();
  }));
}

function collectPatch(id){
  const inputs = Array.from(document.querySelectorAll(`[data-id="${id}"]`));
  const p = {};
  inputs.forEach(el=>{
    const k = el.dataset.k;
    if (el.type === 'checkbox') p[k] = el.checked;
    else if (el.type === 'number') p[k] = el.value ? Number(el.value) : null;
    else p[k] = el.value;
  });
  return p;
}

function renderSummary(){
  // group by outward code (first part of postcode)
  const map = new Map();
  rows.forEach(r=>{
    const pc = (r.postcode||'').toUpperCase().replace(/\s+/g,'');
    const outward = pc ? pc.replace(/.{3}$/, '').trim() : 'UNKNOWN';
    const key = outward || 'UNKNOWN';
    map.set(key, (map.get(key)||0) + 1);
  });
  const list = [...map.entries()].sort((a,b)=> a[0].localeCompare(b[0]));
  const text = list.map(([k,v])=> `${k.padEnd(8,' ')} : ${v}`).join('\n') || 'No data yet.';
  document.getElementById('summary').textContent = text;
}

// Export / Import
document.getElementById('export').addEventListener('click', ()=>{
  const blob = new Blob([JSON.stringify(rows,null,2)], {type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='homes-export.json'; a.click(); URL.revokeObjectURL(a.href);
});
document.getElementById('import').addEventListener('change', async (e)=>{
  const file = e.target.files[0]; if(!file) return;
  const text = await file.text();
  let json = [];
  try{ json = JSON.parse(text); if(!Array.isArray(json)) throw 0; } catch{ return alert('Invalid JSON'); }
  // naive upsert
  for (const row of json){
    row.updated_at = new Date().toISOString();
    await supa.from(TABLE).upsert(row);
  }
  await load();
});

document.getElementById('refresh').addEventListener('click', load);

const esc = s => (''+s).replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]));
load();
</script>
</body>
</html>
