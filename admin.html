<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Spooky Street Map ‚Äî Admin</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <style>
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial;background:#0f0f12;color:#f1f1f3}
    header,footer{padding:12px 16px;border-bottom:1px solid #262631;background:#16161b}
    main{padding:16px;max-width:1100px;margin:0 auto}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{border:1px solid #262631;background:linear-gradient(180deg,#1d1d24,#14141a);color:#f1f1f3;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:600}
    .btn.accent{background:linear-gradient(180deg,#ff8513,#ff6a00);border-color:#ff6a00;color:#0b0b0d}
    table{width:100%;border-collapse:collapse;margin-top:14px}
    th,td{border-bottom:1px solid #262631;padding:8px 6px;text-align:left;font-size:14px}
    input,textarea{background:#121218;color:#f1f1f3;border:1px solid #262631;border-radius:8px;padding:8px}
    .muted{color:#b7b7c0}
    .progress{height:10px;background:#1d1d24;border:1px solid #262631;border-radius:999px;overflow:hidden}
    .bar{height:100%;background:#ff7a00;width:0%}
    .note{font-size:13px;color:#b7b7c0}
    .danger{color:#ff4d4f}
    .ok{color:#35d07f}
    pre{white-space:pre-wrap;background:#0f0f12;border:1px solid #262631;border-radius:8px;padding:8px}
  </style>
</head>
<body>
  <header class="row" style="justify-content:space-between">
    <div class="row"><strong>Admin</strong><span class="muted">Spooky Street Map</span></div>
    <div class="row">
      <a href="/" class="btn">‚Üê Back to map</a>
      <button id="exportBtn" class="btn">‚¨áÔ∏è Export</button>
      <label class="btn"><input id="importFile" type="file" accept="application/json" style="display:none">‚¨ÜÔ∏è Import</label>
      <button id="resetCoords" class="btn accent">üìç Reset all pin coordinates</button>
    </div>
  </header>

  <main>
    <div class="note">This page lets you edit/delete homes and bulk re-geocode coordinates from stored addresses.</div>

    <div id="progressWrap" style="margin:14px 0; display:none">
      <div class="row" style="justify-content:space-between">
        <div id="progressText" class="muted">Preparing‚Ä¶</div>
        <div id="progressCounts" class="muted"></div>
      </div>
      <div class="progress"><div id="progressBar" class="bar"></div></div>
      <div id="errors" class="note danger" style="margin-top:8px; display:none"></div>
    </div>

    <table id="tbl">
      <thead>
        <tr>
          <th>Name</th><th>Address</th><th>Postcode</th><th>Lat</th><th>Lng</th><th>Flags</th><th>Notes</th><th>Actions</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>
  </main>

  <footer class="row" style="justify-content:space-between">
    <span class="note">Coordinates are generated via OpenStreetMap Nominatim (UK-bounded).</span>
    <span class="note">Be considerate: bulk reset is throttled to ~1 req/sec.</span>
  </footer>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
  (function(){
    // ====== CONFIG (same as index) ======
    const SUPABASE_URL = "https://gstufixpbltnarnhrwcb.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdzdHVmaXhwYmx0bmFybmhyd2NiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE1NDEyODMsImV4cCI6MjA3NzExNzI4M30.rg05a4k_uUJopohOHf3RGo5-RZAvVjq85cg1kra_tMw";
    const CLOUD_TABLE = "homes";
    const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    /** @type {Home[]} */ let HOMES = [];
    const els = {
      rows: document.getElementById('rows'),
      exportBtn: document.getElementById('exportBtn'),
      importFile: document.getElementById('importFile'),
      resetBtn: document.getElementById('resetCoords'),
      progressWrap: document.getElementById('progressWrap'),
      progressBar: document.getElementById('progressBar'),
      progressText: document.getElementById('progressText'),
      progressCounts: document.getElementById('progressCounts'),
      errors: document.getElementById('errors'),
    };

    init();

    async function init(){
      await refresh();
      wire();
    }

    async function refresh(){
      const { data, error } = await supa.from(CLOUD_TABLE).select('*').order('updated_at',{ascending:false});
      HOMES = error ? [] : data.map(fromRow);
      render();
    }

    function render(){
      els.rows.innerHTML = '';
      for (const h of HOMES){
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${esc(h.name||'')}</td>
          <td>${esc(h.fullAddress || h.address || '')}</td>
          <td>${esc(h.postcode||'')}</td>
          <td>${isNum(h.lat)?h.lat:''}</td>
          <td>${isNum(h.lng)?h.lng:''}</td>
          <td>${[
            h.flags?.teal?'teal':'' , h.flags?.lights?'lights':'' , h.flags?.music?'music':'' , h.flags?.animatronics?'animatronics':''
          ].filter(Boolean).join(', ')}</td>
          <td>${esc(h.notes||'')}</td>
          <td>
            <button class="btn" data-act="edit" data-id="${h.id}">‚úèÔ∏è</button>
            <button class="btn" data-act="del" data-id="${h.id}">üóëÔ∏è</button>
          </td>`;
        tr.querySelector('[data-act="edit"]').addEventListener('click', ()=> editRow(h));
        tr.querySelector('[data-act="del"]').addEventListener('click', ()=> delRow(h.id));
        els.rows.appendChild(tr);
      }
    }

    function editRow(h){
      const name = prompt('Name', h.name||'');
      if (name===null) return;
      const addr = prompt('Street & Town/City', h.address||'');
      if (addr===null) return;
      const pc = prompt('Postcode', h.postcode||'');
      if (pc===null) return;
      const notes = prompt('Notes', h.notes||'');
      if (notes===null) return;
      const flags = { ...h.flags };
      if (confirm('Toggle Teal pumpkin?')) flags.teal = !flags.teal;
      persist({ ...h, name, address:addr, postcode:pc, notes, flags, updatedAt: Date.now() });
    }

    async function delRow(id){
      if (!confirm('Delete this entry?')) return;
      await supa.from(CLOUD_TABLE).delete().eq('id', id);
      HOMES = HOMES.filter(x=>x.id!==id);
      render();
    }

    // Export & Import
    els.exportBtn.addEventListener('click', ()=>{
      const blob = new Blob([JSON.stringify(HOMES,null,2)], {type:'application/json'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='halloween-homes.json'; a.click(); URL.revokeObjectURL(a.href);
    });
    els.importFile.addEventListener('change', async (e)=>{
      const file = e.target.files?.[0]; if (!file) return;
      try{
        const text = await file.text();
        const list = JSON.parse(text);
        if (!Array.isArray(list)) throw 0;
        // sanitize and upsert
        for (const raw of list){
          const h = sanitizeHome(raw);
          await persist(h);
        }
        await refresh();
        alert('Import complete.');
      }catch{ alert('Import failed: invalid JSON'); }
      e.target.value = '';
    });

    // Reset all coordinates
    els.resetBtn.addEventListener('click', async ()=>{
      if (!HOMES.length) return alert('No homes to process.');
      if (!confirm('Re-geocode ALL homes from their address & postcode?\nThis overwrites existing coordinates.')) return;

      // UI
      els.progressWrap.style.display = 'block';
      els.errors.style.display = 'none';
      els.errors.textContent = '';
      updateProgress(0, HOMES.length, 'Starting‚Ä¶');

      let done = 0, fail = 0;
      for (const h of HOMES){
        const addr = buildFullAddress(h.houseNo, h.address, h.postcode);
        updateProgress(done, HOMES.length, `Resolving: ${addr}`);
        try{
          const pos = await smartGeocode({ houseNo:h.houseNo, address:h.address, postcode:h.postcode });
          const updated = { ...h, lat: pos.lat, lng: pos.lng, updatedAt: Date.now() };
          await persist(updated);
          done++;
        }catch(err){
          fail++;
          addError(`Failed: ${addr}`);
        }
        updateProgress(done, HOMES.length, `Processed ${done+fail}/${HOMES.length}`);
        await wait(1100); // throttle ~1 req/sec
      }
      await refresh();
      updateProgress(HOMES.length, HOMES.length, `Finished. OK: ${done}  Failed: ${fail}`);
    });

    // ====== Geocoding (same strategy as index) ======
    function splitAddress(s){
      const parts = (s || '').split(',').map(x => x.trim()).filter(Boolean);
      return { road: parts[0] || '', place: parts[1] || '' };
    }
    async function fetchGeo(params){
      const url = new URL('https://nominatim.openstreetmap.org/search');
      url.searchParams.set('format','jsonv2');
      url.searchParams.set('limit','1');
      url.searchParams.set('addressdetails','1');
      url.searchParams.set('countrycodes','gb');
      url.searchParams.set('accept-language','en-GB');
      url.searchParams.set('viewbox','-8.35,49.84,1.78,60.86');
      url.searchParams.set('bounded','1');
      for (const [k,v] of Object.entries(params)){ if (v!=null && v!=='') url.searchParams.set(k, v); }
      const res = await fetch(url.toString(), { headers:{'Accept':'application/json'} });
      if (!res.ok) throw new Error('lookup failed');
      const data = await res.json();
      if (!Array.isArray(data) || data.length===0) throw new Error('no results');
      return { lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lon) };
    }
    async function smartGeocode({ houseNo, address, postcode }){
      const pcRaw = (postcode||'').toUpperCase().replace(/\s+/g,'');
      const pc = pcRaw.length<5 ? pcRaw : pcRaw.slice(0,-3)+' '+pcRaw.slice(-3);
      const { road, place } = splitAddress(address || '');
      const street = [houseNo || '', road || ''].filter(Boolean).join(' ').trim();

      if (street || place || pc){ try { return await fetchGeo({ street: street || undefined, city: place || undefined, postalcode: pc || undefined }); } catch {} }
      if (pc){ try { return await fetchGeo({ postalcode: pc }); } catch {} }
      const full = [houseNo, address, pc].filter(Boolean).join(', ');
      if (full){ try { return await fetchGeo({ q: full }); } catch {} }
      throw new Error('Geocoding failed');
    }

    // ====== Supabase helpers ======
    async function persist(h){
      h = sanitizeHome(h);
      const { error } = await supa.from(CLOUD_TABLE).upsert([toRow(h)]);
      if (error) throw error;
      const i = HOMES.findIndex(x=>x.id===h.id); if(i>-1) HOMES[i]=h; else HOMES.push(h);
    }
    function toRow(h){ return { id:h.id, name:h.name, address:h.address, postcode:h.postcode, house_no:h.houseNo, full_address:h.fullAddress, lat:h.lat, lng:h.lng, candy:h.candy||'Mixed', teal:h.flags?.teal, lights:h.flags?.lights, music:h.flags?.music, animatronics:h.flags?.animatronics, notes:h.notes, updated_at:new Date(h.updatedAt||Date.now()).toISOString() }; }
    function fromRow(r){ return sanitizeHome({ id:r.id, name:r.name, address:r.address, postcode:r.postcode, houseNo:r.house_no, fullAddress:r.full_address, lat:r.lat, lng:r.lng, candy:r.candy, flags:{ teal:!!r.teal, lights:!!r.lights, music:!!r.music, animatronics:!!r.animatronics }, notes:r.notes, updatedAt: Date.parse(r.updated_at||Date.now()) }); }

    // ====== UI helpers ======
    function buildFullAddress(no, addr, pc){ return [no||'', addr||'', pc||''].filter(Boolean).join(', '); }
    function sanitizeHome(h){ return { id:h.id, name:(h.name||'').slice(0,120), address:(h.address||'').slice(0,180), postcode:(h.postcode||'').slice(0,16), houseNo:(h.houseNo||'').slice(0,16), fullAddress:(h.fullAddress||'').slice(0,240), lat:isNum(h.lat)?+h.lat:undefined, lng:isNum(h.lng)?+h.lng:undefined, candy:h.candy||'Mixed', flags:{ teal:!!(h.flags&&h.flags.teal), lights: !!(h.flags&&h.flags.lights), music: !!(h.flags&&h.flags.music), animatronics: !!(h.flags&&h.flags.animatronics) }, notes:(h.notes||'').slice(0,500), updatedAt:Number(h.updatedAt||Date.now()) }; }
    function isNum(x){ return typeof x==='number' && !Number.isNaN(x); }
    const esc = s => (s||'').replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]));
    function updateProgress(done,total,msg){
      els.progressWrap.style.display='block';
      const pct = total ? Math.round((done/total)*100) : 0;
      els.progressBar.style.width = pct + '%';
      els.progressText.textContent = msg || '';
      els.progressCounts.textContent = `${done}/${total}`;
    }
    function addError(line){
      els.errors.style.display='block';
      els.errors.textContent += (els.errors.textContent ? '\n' : '') + line;
    }
    const wait = (ms)=> new Promise(r=> setTimeout(r, ms));
  })();

  /**
   * @typedef Home
   * @property {string} id
   * @property {string} name
   * @property {string} address
   * @property {string} postcode
   * @property {string} houseNo
   * @property {string} fullAddress
   * @property {number=} lat
   * @property {number=} lng
   * @property {string} candy
   * @property {{teal:boolean, lights:boolean, music:boolean, animatronics:boolean}} flags
   * @property {string} notes
   * @property {number} updatedAt
   */
  </script>
</body>
</html>
