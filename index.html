<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Spooky Street Map üéÉ (UK)</title>
  <meta name="description" content="Spooky Street Map ‚Äî add your home if you‚Äôre welcoming trick-or-treaters in the UK." />
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='0.9em' font-size='90'%3E%F0%9F%8E%83%3C/text%3E%3C/svg%3E">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <style>
    :root{
      --bg:#0f0f12; --panel:#16161b; --panel-2:#1d1d24; --text:#f1f1f3; --muted:#b7b7c0;
      --accent:#ff7a00; --green:#35d07f; --red:#ff4d4f; --border:#262631; --chip:#242432;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial; color:var(--text);
      background: radial-gradient(1200px 800px at 10% -10%, #2b1535 0%, #0f0f12 50%) fixed;}
    header{position:sticky; top:0; z-index:1000; background:linear-gradient(180deg, rgba(15,15,18,.95), rgba(15,15,18,.7));
      backdrop-filter: blur(8px); border-bottom:1px solid var(--border)}
    .wrap{max-width:1100px; margin:0 auto; padding:14px 18px}
    .brand{display:flex; align-items:center; gap:12px; flex-wrap:wrap}
    .brand h1{font-size:20px; margin:0}
    .actions{margin-left:auto; display:flex; gap:10px}
    .btn{border:1px solid var(--border); background:linear-gradient(180deg, var(--panel), var(--panel-2)); color:var(--text);
      padding:10px 14px; border-radius:10px; cursor:pointer; display:inline-flex; gap:8px; align-items:center; font-weight:600}
    .btn:hover{border-color:#3a3a48}
    .btn.accent{background:linear-gradient(180deg, #ff8513, #ff6a00); border-color:#ff6a00; color:#0b0b0d}
    .btn.ghost{background:transparent}
    .content{display:grid; grid-template-columns: 1.2fr .8fr; gap:16px; max-width:1100px; margin:16px auto; padding:0 18px 30px}
    #map{height:70vh; border:1px solid var(--border); border-radius:14px; overflow:hidden}
    aside{background:linear-gradient(180deg, var(--panel), var(--panel-2)); border:1px solid var(--border); border-radius:14px; padding:14px; min-height:70vh; display:flex; flex-direction:column; gap:12px}
    .searchbar{display:flex; gap:8px}
    input[type="text"], input[type="time"], input[type="date"], textarea, select{width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--border); background:#121218; color:var(--text); outline:none}
    .filters{display:flex; gap:8px; flex-wrap:wrap}
    .chip{border:1px solid var(--border); padding:8px 10px; border-radius:999px; cursor:pointer; background:var(--chip); font-size:13px; color:var(--text); user-select:none}
    .chip.active{outline:2px solid var(--accent); background:#2b1c10}
    .list{overflow:auto; border-top:1px dashed #2b2b36; padding-top:10px}
    .home{border:1px solid var(--border); border-radius:12px; padding:10px; margin-bottom:10px; background:#121218; display:grid; grid-template-columns:auto 1fr; gap:10px}
    .badge{font-size:12px; padding:2px 8px; border-radius:999px; background:#232333; border:1px solid var(--border); color:#b7b7c0}
    .badge.teal{background:#0e2730; color:#99e7ff; border-color:#174c5c}
    .muted{color:var(--muted)}
    .row{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    .kvs{display:flex; gap:12px; flex-wrap:wrap; font-size:13px; color:var(--muted)}
    .kvs span{padding:2px 8px; border-radius:999px; background:#1a1a24; border:1px solid var(--border)}
    .footer{max-width:1100px; margin:0 auto 40px; padding:0 18px; color:var(--muted); font-size:13px}
    dialog{border:none; background:#0e0e13cc; padding:0}
    .modal{width:min(720px,92vw); background:linear-gradient(180deg, var(--panel), var(--panel-2)); border:1px solid var(--border); border-radius:14px; padding:16px; margin:auto; color:var(--text)}
    .grid{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    .grid-3{display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px}
    .full{grid-column:1/-1}
    .note{font-size:12px; color:var(--muted)}
    .danger{color:var(--red)}
    .toolbar{display:flex; gap:8px; flex-wrap:wrap}
    .small{font-size:12px; padding:7px 10px}
    @media(max-width:920px){.content{grid-template-columns:1fr} #map,aside{min-height:60vh}}

    /* Postcode suggestion dropdown */
    .sug { position: relative; }
    .sug ul {
      position: absolute; left: 0; right: 0;
      margin: 6px 0 0; padding: 6px; list-style: none;
      background: #121218; border: 1px solid var(--border); border-radius: 10px;
      max-height: 220px; overflow: auto; z-index: 1001;
    }
    .sug li { padding: 8px 10px; border-radius: 8px; cursor: pointer; color: var(--text); }
    .sug li:hover { background: #1a1a24; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <header>
    <div class="wrap brand">
      <div class="row"><span style="font-size:22px">üéÉ</span><h1>Spooky Street Map</h1><span class="muted">Add your home if you‚Äôre welcoming trick-or-treaters</span></div>
      <div class="actions">
        <button id="addHomeBtn" class="btn accent">‚ûï Add Your Home</button>
        <button id="exportBtn" class="btn">‚¨áÔ∏è Export</button>
        <button id="importBtn" class="btn ghost">‚¨ÜÔ∏è Import</button>
      </div>
    </div>
  </header>

  <main class="content">
    <div id="map" aria-label="Map of homes"></div>
    <aside>
      <div class="searchbar"><input id="search" type="text" placeholder="Search address, house name, notes‚Ä¶" aria-label="Search"></div>
      <div class="filters">
        <span class="chip" data-filter="teal">Teal pumpkin (allergy-friendly)</span>
        <span class="chip" data-filter="lights">Lots of lights</span>
        <span class="chip" data-filter="music">Spooky music</span>
        <span class="chip" data-filter="animatronics">Animatronics</span>
      </div>
      <div class="list" id="list" aria-live="polite"></div>
    </aside>
  </main>

  <section class="footer">
    Tip: Use a nearby corner if you prefer privacy. Addresses can also be shared to the cloud so everyone sees the same list.
  </section>

  <!-- Add / Edit Modal -->
  <dialog id="addDialog">
    <form method="dialog" class="modal" id="homeForm">
      <header class="row" style="justify-content:space-between; margin-bottom:8px">
        <h2 style="margin:0">Add Your Home</h2>
        <button class="btn small ghost" value="cancel">‚úñ Close</button>
      </header>
      <div class="grid">
        <div class="full"><label>House name (optional)
          <input type="text" id="name" placeholder="e.g., The Cobweb Cottage"></label></div>
        <div><label>House number
          <input type="text" id="houseNo" placeholder="e.g., 12"></label></div>
        <div><label>Postcode
          <input type="text" id="postcode" placeholder="e.g., DE7 9JL">
          <div id="pcSuggest" class="sug hidden"></div>
        </label></div>
        <div class="full"><label>Street & Town/City
          <input type="text" id="address" list="addrSuggestions" placeholder="e.g., Stoppard Close, Ilkeston, Derbyshire" required></label></div>

        <!-- Hidden date/time (kept for DB compatibility) -->
        <div id="dateRow" style="display:none"><label>Halloween date
          <input type="date" id="date"></label></div>
        <div class="grid-3" id="timeRow" style="display:none">
          <label id="startLabel">Start <input type="time" id="start"></label>
          <label id="endLabel">End <input type="time" id="end"></label>
          <label>Candy type
            <select id="candy"><option>Mixed</option><option>Chocolate</option><option>Sweets</option><option>Prize/Non-food</option></select>
          </label>
        </div>
        <div class="full row" style="gap:14px">
          <label class="row" style="gap:6px"><input type="checkbox" id="teal"> Teal pumpkin</label>
          <label class="row" style="gap:6px"><input type="checkbox" id="lights"> Lots of lights</label>
          <label class="row" style="gap:6px"><input type="checkbox" id="music"> Spooky music</label>
          <label class="row" style="gap:6px"><input type="checkbox" id="animatronics"> Animatronics</label>
        </div>
        <div class="full"><label>Notes
          <textarea id="notes" rows="3" placeholder="Accessibility, pets, instructions‚Ä¶"></textarea></label></div>
      </div>
      <div style="margin-top:12px" class="toolbar">
        <button class="btn accent" id="saveBtn" value="confirm">Save Home</button>
        <button id="geocodeBtn" class="btn">üìç Preview Map Pin</button>
        <span class="note">Pins placed via OpenStreetMap; drag if needed.</span>
      </div>
      <div id="previewMap" style="height:280px; margin-top:10px; border:1px solid var(--border); border-radius:12px; display:none"></div>
      <p class="note" style="margin-top:10px">Data saves to the cloud if configured below, otherwise only in this browser.</p>
      <p class="note danger" id="errorMsg" style="display:none"></p>

      <datalist id="addrSuggestions"></datalist>
    </form>
  </dialog>

  <!-- Import Modal -->
  <dialog id="importDialog">
    <form method="dialog" class="modal">
      <header class="row" style="justify-content:space-between; margin-bottom:8px"><h2 style="margin:0">Import Homes</h2><button class="btn small ghost" value="cancel">‚úñ Close</button></header>
      <textarea id="importText" rows="10" placeholder='Paste JSON from Export here'></textarea>
      <div class="toolbar" style="margin-top:10px"><button class="btn accent" id="doImport" value="confirm">Import</button><span class="note">This replaces your current list.</span></div>
    </form>
  </dialog>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
  (function(){
    // Toggle this to true if you ever want to show Delete buttons again:
    const ADMIN_MODE = false;

    // ====== CLOUD CONFIG ======
    const SUPABASE_URL = "https://gstufixpbltnarnhrwcb.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdzdHVmaXhwYmx0bmFybmhyd2NiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE1NDEyODMsImV4cCI6MjA3NzExNzI4M30.rg05a4k_uUJopohOHf3RGo5-RZAvVjq85cg1kra_tMw";
    const CLOUD_TABLE = 'homes';
    let supa = null; let cloudMode = false;

    if (SUPABASE_URL && SUPABASE_ANON_KEY) {
      supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      cloudMode = true;
    }

    // ====== Storage & State ======
    const KEY = 'halloween_houses_v2';
    /** @type {Home[]} */
    let HOMES = [];
    let MAP, LAYER, PREVIEW_MAP, PREVIEW_MARKER;

    const els = {
      map: document.getElementById('map'), list: document.getElementById('list'), search: document.getElementById('search'),
      chips: Array.from(document.querySelectorAll('.chip')),
      addBtn: document.getElementById('addHomeBtn'), exportBtn: document.getElementById('exportBtn'), importBtn: document.getElementById('importBtn'),
      addDialog: document.getElementById('addDialog'), importDialog: document.getElementById('importDialog'), importText: document.getElementById('importText'), doImport: document.getElementById('doImport'),
      name: document.getElementById('name'), address: document.getElementById('address'), postcode: document.getElementById('postcode'), houseNo: document.getElementById('houseNo'),
      date: document.getElementById('date'), start: document.getElementById('start'), end: document.getElementById('end'), candy: document.getElementById('candy'),
      teal: document.getElementById('teal'), lights: document.getElementById('lights'), music: document.getElementById('music'), animatronics: document.getElementById('animatronics'),
      notes: document.getElementById('notes'), saveBtn: document.getElementById('saveBtn'), geocodeBtn: document.getElementById('geocodeBtn'), previewMap: document.getElementById('previewMap'), errorMsg: document.getElementById('errorMsg'),
      dateRow: document.getElementById('dateRow'), timeRow: document.getElementById('timeRow'), addrSuggestions: document.getElementById('addrSuggestions')
    };

    // Hide date/time UI (kept for DB compatibility)
    if (els.dateRow) els.dateRow.style.display = 'none';
    if (els.timeRow) els.timeRow.style.display = 'none';

    // Default Halloween date (kept but hidden)
    const now = new Date();
    const defaultDate = new Date(now.getFullYear(), 9, 31);
    if (els.date) els.date.valueAsDate = defaultDate;

    // Load and initialize
    async function init(){
      if (cloudMode){ await cloudLoad(); subscribeRealtime(); }
      else { loadLocal(); seedIfEmpty(); }
      initMap();
      render();
      fitAllMarkers();
    }

    function loadLocal(){ try{ HOMES = JSON.parse(localStorage.getItem(KEY) || "[]"); } catch{ HOMES = [] } }
    function saveLocal(){ localStorage.setItem(KEY, JSON.stringify(HOMES)); render(); }

    async function cloudLoad(){
      const { data, error } = await supa.from(CLOUD_TABLE).select('*').order('updated_at', { ascending:false });
      if (!error && Array.isArray(data)) { HOMES = data.map(fromRow); }
      else { console.error(error); HOMES = []; }
    }

    async function cloudUpsert(home){
      const row = toRow(home);
      const { data, error } = await supa.from(CLOUD_TABLE).upsert(row).select();
      if (error) throw error; return data?.[0] ? fromRow(data[0]) : home;
    }

    async function cloudDelete(id){ await supa.from(CLOUD_TABLE).delete().eq('id', id); }

    function subscribeRealtime(){
      supa.channel('public:homes')
        .on('postgres_changes', { event:'*', schema:'public', table:CLOUD_TABLE }, payload => {
          const { eventType, new: n, old } = payload;
          if (eventType === 'INSERT' || eventType === 'UPDATE'){
            upsertLocal(fromRow(n), true); fitAllMarkers();
          } else if (eventType === 'DELETE'){
            HOMES = HOMES.filter(h=>h.id!==old.id); render(); fitAllMarkers();
          }
        })
        .subscribe();
    }

    // Seed sample if empty (local only)
    function seedIfEmpty(){ if (HOMES.length) return; HOMES.push({ id: cryptoRandom(), name:'Pumpkin Porch', fullAddress:'Town Square', address: 'Town Square', postcode:'', houseNo:'', lat:51.5074, lng:-0.1278, date: toISODate(defaultDate), start:'', end:'', candy:'Mixed', flags:{teal:true, lights:true, music:true, animatronics:false}, notes:'Friendly for all ages.', updatedAt: Date.now() }); saveLocal(); }

    // ====== Map ======
    function initMap(){
      MAP = L.map('map', {scrollWheelZoom:true});
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution:'&copy; OpenStreetMap contributors' }).addTo(MAP);
      LAYER = L.layerGroup().addTo(MAP);
      MAP.setView([54.5, -3.4], 5);
      if (navigator.geolocation){ navigator.geolocation.getCurrentPosition(pos=>MAP.setView([pos.coords.latitude, pos.coords.longitude], 13), ()=>{}); }
    }

    function markerIcon(color){ return L.divIcon({ className:'custom-pin', html:`<div style="width:18px;height:18px;border-radius:50%;background:${color};border:2px solid #0b0b0d;box-shadow:0 0 0 2px rgba(0,0,0,.2)"></div>`, iconSize:[18,18] }); }
    function colorFor(h){ return h.flags?.teal ? '#2fb1d9' : '#ff7a00'; }

    function render(){
      LAYER.clearLayers();
      const q = els.search.value.trim().toLowerCase();
      const activeFilters = new Set(els.chips.filter(c=>c.classList.contains('active')).map(c=>c.dataset.filter));
      const filtered = HOMES.filter(h=>{
        const hay = (h.name||'') + ' ' + (h.fullAddress||'') + ' ' + (h.notes||'');
        if (q && !hay.toLowerCase().includes(q)) return false;
        if (activeFilters.has('teal') && !h.flags?.teal) return false;
        if (activeFilters.has('lights') && !h.flags?.lights) return false;
        if (activeFilters.has('music') && !h.flags?.music) return false;
        if (activeFilters.has('animatronics') && !h.flags?.animatronics) return false;
        return true;
      });

      const bounds = [];
      filtered.forEach(h=>{
        if (isNumber(h.lat) && isNumber(h.lng)){
          const m = L.marker([h.lat,h.lng], { icon: markerIcon(colorFor(h)), draggable:true }).addTo(LAYER);
          m.bindPopup(popupHTML(h));
          m.on('dragend', e=>{ const {lat,lng}=e.target.getLatLng(); h.lat=lat; h.lng=lng; h.updatedAt=Date.now(); persist(h); });
          bounds.push([h.lat,h.lng]);
        }
      });
      if (bounds.length) try{ MAP.fitBounds(bounds,{padding:[40,40]}); }catch{}

      els.list.innerHTML = '';
      if (!filtered.length){ els.list.innerHTML = `<p class="muted">No homes match your filters yet.</p>`; }
      else filtered
        .sort((a,b)=>((a.fullAddress||'').localeCompare(b.fullAddress||'')))
        .forEach(h=> els.list.appendChild(homeRow(h)) );
    }

    function homeRow(h){
      const el = document.createElement('div'); el.className='home';
      el.innerHTML = `
        <div class="row" style="flex-direction:column; gap:6px">
          ${h.flags?.teal?'<span class="badge teal">Teal pumpkin</span>':''}
        </div>
        <div>
          <div class="row" style="justify-content:space-between">
            <strong>${escapeHTML(h.name||'Halloween House')}</strong>
            <span class="muted">${escapeHTML(h.fullAddress||'')}</span>
          </div>
          <div class="kvs" style="margin:6px 0 8px">
            <span>üéÉ ${escapeHTML(h.candy||'Mixed')}</span>
          </div>
          <div class="muted">${escapeHTML(h.notes||'')}</div>
          <div class="row" style="margin-top:8px; gap:10px; flex-wrap:wrap">
            ${h.flags?.lights?'<span class="badge">Lights</span>':''}
            ${h.flags?.music?'<span class="badge">Music</span>':''}
            ${h.flags?.animatronics?'<span class="badge">Animatronics</span>':''}
            <button class="btn small ghost" data-id="${h.id}" data-act="center">üìç Center</button>
            <button class="btn small" data-id="${h.id}" data-act="edit">‚úèÔ∏è Edit</button>
            ${ADMIN_MODE ? `<button class="btn small ghost danger" data-id="${h.id}" data-act="delete">üóëÔ∏è Delete</button>` : ``}
          </div>
        </div>`;
      el.querySelectorAll('button').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const id = btn.dataset.id; const act = btn.dataset.act; const item = HOMES.find(x=>x.id===id); if (!item) return;
          if (act==='center' && isNumber(item.lat)&&isNumber(item.lng)) MAP.setView([item.lat,item.lng], 18, {animate:true});
          else if (act==='edit') openAddDialog(item);
          else if (act==='delete' && ADMIN_MODE) if (confirm('Remove this home?')) removeHome(item.id);
        });
      });
      return el;
    }

    function popupHTML(h){
      return `<strong>${escapeHTML(h.name||'Halloween House')}</strong><br>
        <span class="muted">${escapeHTML(h.fullAddress||'')}</span><br>
        ${h.flags?.teal?'<span class="badge teal">Teal pumpkin</span><br>':''}
        <div style="margin-top:6px">${escapeHTML(h.notes||'')}</div>`;
    }

    // ====== Postcode ‚Üí Address suggestions & Auto-Preview ======
    const pcSuggestEl = document.getElementById('pcSuggest');

    const suggest = debounce(async ()=>{
      const pcRaw = (els.postcode.value||'').toUpperCase().replace(/\s+/g,'');
      if (pcRaw.length < 5){ hidePcSuggestions(); return; }
      const pc = formatUKPostcode(pcRaw);
      if (!pc){ hidePcSuggestions(); return; }
      els.postcode.value = pc; // show normalised form

      try{
        const url = new URL('https://nominatim.openstreetmap.org/search');
        url.searchParams.set('format', 'jsonv2');
        url.searchParams.set('q', pc + ' UK');
        url.searchParams.set('limit', '8');
        url.searchParams.set('addressdetails', '1');
        url.searchParams.set('countrycodes', 'gb');
        const res = await fetch(url.toString(), { headers: { 'Accept': 'application/json' } });
        if (!res.ok) throw new Error('lookup failed');
        const data = await res.json();

        const options = [];
        const seen = new Set();
        for (const row of data){
          const a = row.address || {};
          const road = a.road || a.pedestrian || a.footway || a.path || a.residential || '';
          const town = a.village || a.town || a.city || a.suburb || a.hamlet || a.county || '';
          if (!road || !town) continue;
          const s = `${road}, ${town}`;
          if (!seen.has(s)){ seen.add(s); options.push(s); }
        }
        renderPcSuggestions(options);
      }catch(e){
        hidePcSuggestions();
      }
    }, 280);

    function renderPcSuggestions(list){
      if (!pcSuggestEl) return;
      if (!list.length){
        pcSuggestEl.classList.add('hidden');
        pcSuggestEl.innerHTML = '';
        return;
      }
      const html = '<ul>' + list.slice(0,12).map(s => `<li data-addr="${s.replace(/"/g,'&quot;')}">${s}</li>`).join('') + '</ul>';
      pcSuggestEl.innerHTML = html;
      pcSuggestEl.classList.remove('hidden');
      pcSuggestEl.querySelectorAll('li').forEach(li=>{
        li.addEventListener('click', async ()=>{
          const chosen = li.getAttribute('data-addr') || '';
          document.getElementById('address').value = chosen;
          hidePcSuggestions();
          await maybePreview(); // <‚Äî auto-preview after choosing
          document.getElementById('houseNo').focus();
        });
      });
    }
    function hidePcSuggestions(){
      if (!pcSuggestEl) return;
      pcSuggestEl.classList.add('hidden');
      pcSuggestEl.innerHTML = '';
    }

    function formatUKPostcode(s){
      if (s.length < 5) return null;
      return s.slice(0, -3) + ' ' + s.slice(-3);
    }

    // Auto-preview when we have enough info (postcode + address OR fullAddress)
    const previewDebounced = debounce(maybePreview, 350);
    document.getElementById('postcode').addEventListener('input', suggest);
    document.getElementById('postcode').addEventListener('blur', previewDebounced);
    document.getElementById('postcode').addEventListener('keydown', (e)=>{ if (e.key === 'Escape') hidePcSuggestions(); });
    document.addEventListener('click', (e)=>{ if (!pcSuggestEl.contains(e.target) && e.target.id !== 'postcode'){ hidePcSuggestions(); }});
    document.getElementById('address').addEventListener('input', previewDebounced);

    async function maybePreview(){
      const full = buildFullAddress(els.houseNo.value, els.address.value, els.postcode.value);
      if (!full.trim()) return;
      try{
        const pos = await geocode(full);
        showPreviewAt(pos.lat, pos.lng);
      }catch{
        showError('Could not preview that address yet. You can still save and drag the pin.');
      }
    }

    function showPreviewAt(lat,lng){
      els.previewMap.style.display = 'block';
      if (!PREVIEW_MAP){
        PREVIEW_MAP = L.map('previewMap', {scrollWheelZoom:false});
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'&copy; OpenStreetMap'}).addTo(PREVIEW_MAP);
      }
      if (!PREVIEW_MARKER){ PREVIEW_MARKER = L.marker([lat,lng], {draggable:true}).addTo(PREVIEW_MAP); }
      else { PREVIEW_MARKER.setLatLng([lat,lng]); }
      PREVIEW_MAP.setView([lat,lng], 16);
    }

    async function geocode(q){
      const url = new URL('https://nominatim.openstreetmap.org/search');
      url.searchParams.set('format','json');
      url.searchParams.set('q', q);
      url.searchParams.set('limit','1');
      url.searchParams.set('addressdetails','0');
      url.searchParams.set('countrycodes','gb');
      const res = await fetch(url.toString(), {headers:{'Accept':'application/json'}});
      if (!res.ok) throw new Error('Geocoding failed');
      const data = await res.json();
      if (!data?.length) throw new Error('No results');
      return {lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lon)};
    }

    // ====== Add/Edit ======
    let editing = null;
    function openAddDialog(existing){
      editing = existing?.id || null; els.errorMsg.style.display='none'; els.previewMap.style.display='none';
      els.houseNo.value = existing?.houseNo || '';
      els.postcode.value = existing?.postcode || '';
      els.address.value  = existing?.address  || '';
      els.name.value = existing?.name||''; els.date.value = existing?.date || (els.date?.value ?? ''); els.start.value = existing?.start||''; els.end.value = existing?.end||''; els.candy.value = existing?.candy||'Mixed';
      els.teal.checked = !!existing?.flags?.teal; els.lights.checked=!!existing?.flags?.lights; els.music.checked=!!existing?.flags?.music; els.animatronics.checked=!!existing?.flags?.animatronics; els.notes.value = existing?.notes||'';
      document.getElementById('homeForm').reset; els.addDialog.showModal(); setTimeout(()=> initPreview(existing), 100);
      hidePcSuggestions();
    }

    function initPreview(existing){
      if (!PREVIEW_MAP){
        els.previewMap.style.display='block';
        PREVIEW_MAP = L.map('previewMap', {scrollWheelZoom:false});
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'&copy; OpenStreetMap'}).addTo(PREVIEW_MAP);
        PREVIEW_MAP.setView([54.5,-3.4],5);
      }
      if (existing && isNumber(existing.lat) && isNumber(existing.lng)){
        if (!PREVIEW_MARKER){ PREVIEW_MARKER = L.marker([existing.lat, existing.lng], {draggable:true}).addTo(PREVIEW_MAP); }
        else PREVIEW_MARKER.setLatLng([existing.lat, existing.lng]);
        PREVIEW_MAP.setView([existing.lat, existing.lng], 15);
      } else {
        if (PREVIEW_MARKER){ PREVIEW_MAP.removeLayer(PREVIEW_MARKER); PREVIEW_MARKER=null; }
        PREVIEW_MAP.setView([54.5,-3.4],5);
      }
    }

    // Preview button (manual)
    document.getElementById('geocodeBtn').addEventListener('click', async (e)=>{
      e.preventDefault(); els.errorMsg.style.display='none';
      const full = buildFullAddress(els.houseNo.value, els.address.value, els.postcode.value);
      if (!full){ showError('Please enter address details.'); return; }
      try{
        const pos = await geocode(full);
        showPreviewAt(pos.lat, pos.lng);
      }catch{ showError('Could not find that address. You can still save and drag the pin later.'); }
    });

    // Save
    document.getElementById('saveBtn').addEventListener('click', async (e)=>{
      e.preventDefault(); els.errorMsg.style.display='none';
      const item = collectForm();
      if (!item.address){ showError('Street & town/city is required.'); return; }
      item.fullAddress = buildFullAddress(item.houseNo, item.address, item.postcode) || item.address;

      if (PREVIEW_MARKER){ const ll = PREVIEW_MARKER.getLatLng(); item.lat = ll.lat; item.lng = ll.lng; }
      if (!isNumber(item.lat) || !isNumber(item.lng)){
        try{ const pos = await geocode(item.fullAddress); item.lat = pos.lat; item.lng = pos.lng; }catch{/* ok */ }
      }

      try{
        if (editing){ item.id = editing; await persist(item); }
        else { item.id = cryptoRandom(); await persist(item); }
        els.addDialog.close();
        if (PREVIEW_MARKER){ PREVIEW_MAP.removeLayer(PREVIEW_MARKER); PREVIEW_MARKER=null; }
        els.previewMap.style.display='none';
        fitAllMarkers();
      }catch(err){ showError('Save failed. If cloud is enabled, check your keys and table.'); console.error(err); }
    });

    document.getElementById('exportBtn').addEventListener('click', ()=>{ const blob = new Blob([JSON.stringify(HOMES,null,2)], {type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='halloween-homes.json'; a.click(); URL.revokeObjectURL(a.href); });
    document.getElementById('importBtn').addEventListener('click', ()=>{ els.importText.value=''; els.importDialog.showModal(); });
    document.getElementById('doImport').addEventListener('click', (e)=>{ e.preventDefault(); try{ const data = JSON.parse(els.importText.value||'[]'); if (!Array.isArray(data)) throw new Error('Invalid JSON'); HOMES = data.map(sanitizeHome); persistAll(HOMES); els.importDialog.close(); fitAllMarkers(); }catch{ alert('Import failed. Paste valid JSON.'); } });

    async function removeHome(id){ HOMES = HOMES.filter(x=>x.id!==id); if (cloudMode){ await cloudDelete(id); } persistAll(HOMES); fitAllMarkers(); }

    // ====== Helpers ======
    function collectForm(){ return sanitizeHome({ name: els.name.value.trim(), address: els.address.value.trim(), postcode: els.postcode.value.trim(), houseNo: els.houseNo.value.trim(), date: els.date?.value || toISODate(new Date()), start: els.start?.value || '', end: els.end?.value || '', candy: els.candy.value, flags:{ teal: !!els.teal.checked, lights: !!els.lights.checked, music: !!els.music.checked, animatronics: !!els.animatronics.checked }, notes: els.notes.value.trim(), updatedAt: Date.now() }); }

    function sanitizeHome(h){ return { id: h.id || cryptoRandom(), name:(h.name||'').slice(0,120), address:(h.address||'').slice(0,180), postcode:(h.postcode||'').slice(0,16), houseNo:(h.houseNo||'').slice(0,16), fullAddress: (h.fullAddress||'').slice(0,240), lat: isNumber(h.lat)?Number(h.lat):undefined, lng: isNumber(h.lng)?Number(h.lng):undefined, date: h.date || toISODate(new Date()), start: h.start||'', end: h.end||'', candy: h.candy||'Mixed', flags:{ teal: !!(h.flags&&h.flags.teal), lights: !!(h.flags&&h.flags.lights), music: !!(h.flags&&h.flags.music), animatronics: !!(h.flags&&h.flags.animatronics) }, notes:(h.notes||'').slice(0,500), updatedAt: Number(h.updatedAt||Date.now()) }; }

    function buildFullAddress(no, addr, pc){ return [no||'', addr||'', pc||''].filter(Boolean).join(', '); }
    function toISODate(d){ return new Date(d).toISOString().slice(0,10); }
    function isNumber(x){ return typeof x==='number' && !Number.isNaN(x); }
    function cryptoRandom(){ return (self.crypto?.getRandomValues ? [...crypto.getRandomValues(new Uint8Array(16))].map(b=>b.toString(16).padStart(2,'0')).join('') : Math.random().toString(36).slice(2)); }
    function escapeHTML(s){ return (s||'').replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;' }[c])); }
    function debounce(fn,ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; }
    function showError(msg){ els.errorMsg.textContent=msg; els.errorMsg.style.display='block'; }

    function upsertLocal(h, doRender=true){ const idx = HOMES.findIndex(x=>x.id===h.id); if (idx>-1) HOMES[idx]=h; else HOMES.push(h); if (doRender) render(); }

    async function persist(h){ h = sanitizeHome(h); upsertLocal(h, false); if (cloudMode){ const saved = await cloudUpsert(h); upsertLocal(saved, false); } else saveLocal(); render(); }
    function persistAll(list){ if (cloudMode){ HOMES = list.map(sanitizeHome); render(); } else { localStorage.setItem(KEY, JSON.stringify(list)); render(); } }

    function toRow(h){ return { id:h.id, name:h.name, address:h.address, postcode:h.postcode, house_no:h.houseNo, full_address:h.fullAddress, lat:h.lat, lng:h.lng, date:h.date, start:h.start, end:h.end, candy:h.candy, teal: !!h.flags?.teal, lights: !!h.flags?.lights, music: !!h.flags?.music, animatronics: !!h.flags?.animatronics, notes:h.notes, updated_at: new Date(h.updatedAt).toISOString() }; }
    function fromRow(r){ return sanitizeHome({ id:r.id, name:r.name, address:r.address, postcode:r.postcode, houseNo:r.house_no, fullAddress:r.full_address, lat:r.lat, lng:r.lng, date:r.date, start:r.start, end:r.end, candy:r.candy, flags:{ teal:!!r.teal, lights:!!r.lights, music:!!r.music, animatronics:!!r.animatronics }, notes:r.notes, updatedAt: Date.parse(r.updated_at||Date.now()) }); }

    function fitAllMarkers(){
      const pts = HOMES.filter(h=>isNumber(h.lat)&&isNumber(h.lng)).map(h=>[h.lat,h.lng]);
      if (pts.length){ try{ MAP.fitBounds(pts,{padding:[40,40]}); }catch{} }
    }

    // Init
    init();

    // Shortcuts & dialog handling
    document.addEventListener('keydown', (e)=>{ if ((e.ctrlKey||e.metaKey)&&e.key.toLowerCase()==='k'){ e.preventDefault(); document.getElementById('search').focus(); } if ((e.ctrlKey||e.metaKey)&&e.key.toLowerCase()==='n'){ e.preventDefault(); openAddDialog(null); } });
    [document.getElementById('addDialog'), document.getElementById('importDialog')].forEach(dlg=> dlg.addEventListener('click', (e)=>{ if (e.target===dlg) dlg.close(); }));
  })();

  /**
   * @typedef Home
   * @property {string} id
   * @property {string} name
   * @property {string} address
   * @property {string} postcode
   * @property {string} houseNo
   * @property {string} fullAddress
   * @property {number=} lat
   * @property {number=} lng
   * @property {string} date
   * @property {string} start
   * @property {string} end
   * @property {string} candy
   * @property {{teal:boolean, lights:boolean, music:boolean, animatronics:boolean}} flags
   * @property {string} notes
   * @property {number} updatedAt
   */
  </script>
</body>
</html>
