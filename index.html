<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Spooky Street Map üéÉ (UK)</title>
  <meta name="description" content="Spooky Street Map ‚Äî add your home if you‚Äôre welcoming trick-or-treaters in the UK." />
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='0.9em' font-size='90'%3E%F0%9F%8E%83%3C/text%3E%3C/svg%3E">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <style>
    :root{
      --bg:#0f0f12; --panel:#16161b; --panel-2:#1d1d24; --text:#f1f1f3; --muted:#b7b7c0;
      --accent:#ff7a00; --green:#35d07f; --red:#ff4d4f; --border:#262631; --chip:#242432;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial; color:var(--text);
      background: radial-gradient(1200px 800px at 10% -10%, #2b1535 0%, #0f0f12 50%) fixed;}
    header{position:sticky; top:0; z-index:1000; background:linear-gradient(180deg, rgba(15,15,18,.95), rgba(15,15,18,.7));
      backdrop-filter: blur(8px); border-bottom:1px solid var(--border)}
    .wrap{max-width:1100px; margin:0 auto; padding:14px 18px}
    .brand{display:flex; align-items:center; gap:12px; flex-wrap:wrap}
    .brand h1{font-size:20px; margin:0}
    .countdown{margin-left:auto; font-weight:700; color:#ffd9b3}
    .actions{display:flex; gap:10px}
    .btn{border:1px solid var(--border); background:linear-gradient(180deg, var(--panel), var(--panel-2)); color:var(--text);
      padding:10px 14px; border-radius:10px; cursor:pointer; display:inline-flex; gap:8px; align-items:center; font-weight:600}
    .btn:hover{border-color:#3a3a48}
    .btn.accent{background:linear-gradient(180deg, #ff8513, #ff6a00); border-color:#ff6a00; color:#0b0b0d}
    .btn.ghost{background:transparent}
    .content{display:grid; grid-template-columns: 1.2fr .8fr; gap:16px; max-width:1100px; margin:16px auto; padding:0 18px 30px}
    #map{height:70vh; border:1px solid var(--border); border-radius:14px; overflow:hidden}
    aside{background:linear-gradient(180deg, var(--panel), var(--panel-2)); border:1px solid var(--border); border-radius:14px; padding:14px; min-height:70vh; display:flex; flex-direction:column; gap:12px}
    .searchbar{display:flex; gap:8px}
    input[type="text"], textarea, select{width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--border); background:#121218; color:#f1f1f3; outline:none}
    .filters{display:flex; gap:8px; flex-wrap:wrap}
    .chip{border:1px solid var(--border); padding:8px 10px; border-radius:999px; cursor:pointer; background:var(--chip); font-size:13px; color:#f1f1f3; user-select:none}
    .chip.active{outline:2px solid var(--accent); background:#2b1c10}
    .list{overflow:auto; border-top:1px dashed #2b2b36; padding-top:10px}
    .home{border:1px solid var(--border); border-radius:12px; padding:10px; margin-bottom:10px; background:#121218; display:grid; grid-template-columns:auto 1fr; gap:10px}
    .badge{font-size:12px; padding:2px 8px; border-radius:999px; background:#232333; border:1px solid var(--border); color:#b7b7c0}
    .badge.teal{background:#0e2730; color:#99e7ff; border-color:#174c5c}
    .muted{color:#b7b7c0}
    .row{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    .kvs{display:flex; gap:12px; flex-wrap:wrap; font-size:13px; color:#b7b7c0}
    .kvs span{padding:2px 8px; border-radius:999px; background:#1a1a24; border:1px solid var(--border)}
    .footer{max-width:1100px; margin:0 auto 40px; padding:0 18px; color:#b7b7c0; font-size:13px}
    dialog{border:none; background:#0e0e13cc; padding:0}
    .modal{width:min(720px,92vw); background:linear-gradient(180deg, var(--panel), var(--panel-2)); border:1px solid var(--border); border-radius:14px; padding:16px; margin:auto; color:#f1f1f3}
    .grid{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    .full{grid-column:1/-1}
    .note{font-size:12px; color:#b7b7c0}
    .danger{color:#ff4d4f}
    .small{font-size:12px; padding:7px 10px}
    @media(max-width:920px){.content{grid-template-columns:1fr} #map,aside{min-height:60vh}}

    /* Postcode suggestion dropdown */
    .sug { position: relative; }
    .sug ul {
      position: absolute; left: 0; right: 0; margin: 6px 0 0; padding: 6px; list-style: none;
      background: #121218; border: 1px solid var(--border); border-radius: 10px;
      max-height: 220px; overflow: auto; z-index: 1001;
    }
    .sug li { padding: 8px 10px; border-radius: 8px; cursor: pointer; color: #f1f1f3; }
    .sug li:hover { background: #1a1a24; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <header>
    <div class="wrap brand">
      <div class="row"><span style="font-size:22px">üéÉ</span><h1>Spooky Street Map</h1><span class="muted">Add your home if you‚Äôre welcoming trick-or-treaters</span></div>
      <div class="countdown" id="countdown" aria-live="polite"></div>
      <div class="actions">
        <button id="addHomeBtn" class="btn accent">‚ûï Add Your Home</button>
      </div>
    </div>
  </header>

  <main class="content">
    <div id="map" aria-label="Map of homes"></div>
    <aside>
      <div class="searchbar"><input id="search" type="text" placeholder="Search by street, town, postcode‚Ä¶" aria-label="Search"></div>
      <div class="filters">
        <span class="chip" data-filter="teal">Teal pumpkin</span>
        <span class="chip" data-filter="lights">Lots of lights</span>
        <span class="chip" data-filter="music">Spooky music</span>
        <span class="chip" data-filter="animatronics">Animatronics</span>
      </div>
      <div class="list" id="list" aria-live="polite"></div>
    </aside>
  </main>

  <section class="footer">
    Tip: Use a nearby corner if you prefer privacy. <a href="/admin.html">Admin</a> page has export/import & moderation.
  </section>

  <!-- Add / Edit Modal -->
  <dialog id="addDialog">
    <form method="dialog" class="modal" id="homeForm">
      <header class="row" style="justify-content:space-between; margin-bottom:8px">
        <h2 style="margin:0">Add Your Home</h2>
        <button class="btn small ghost" value="cancel">‚úñ Close</button>
      </header>
      <div class="grid">
        <div class="full"><label>House name (optional)
          <input type="text" id="name" placeholder="e.g., The Cobweb Cottage"></label></div>
        <div><label>House number
          <input type="text" id="houseNo" placeholder="e.g., 12"></label></div>
        <div class="full"><label>Postcode
          <input type="text" id="postcode" placeholder="e.g., DE7 9JL">
          <div id="pcSuggest" class="sug hidden"></div>
        </label></div>
        <div class="full"><label>Street & Town/City
          <input type="text" id="address" placeholder="e.g., Stoppard Close, Ilkeston, Derbyshire" required></label></div>
        <div class="full"><label>Notes
          <textarea id="notes" rows="3" placeholder="Accessibility, pets, instructions‚Ä¶"></textarea></label></div>
        <div class="full" style="display:flex;gap:14px;flex-wrap:wrap">
          <label><input type="checkbox" id="teal"> Teal pumpkin</label>
          <label><input type="checkbox" id="lights"> Lots of lights</label>
          <label><input type="checkbox" id="music"> Spooky music</label>
          <label><input type="checkbox" id="animatronics"> Animatronics</label>
        </div>
      </div>
      <div style="margin-top:12px; display:flex; gap:8px; align-items:center">
        <button class="btn accent" id="saveBtn" value="confirm">Save Home</button>
        <button id="geocodeBtn" class="btn">üìç Preview Map Pin</button>
        <span class="note">Pins placed via OpenStreetMap; drag if needed.</span>
      </div>
      <div id="previewMap" style="height:280px; margin-top:10px; border:1px solid var(--border); border-radius:12px; display:none"></div>
      <p class="note danger" id="errorMsg" style="display:none"></p>
    </form>
  </dialog>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
  (function(){
    // ====== CONFIG ======
    const SUPABASE_URL = "https://gstufixpbltnarnhrwcb.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdzdHVmaXhwYmx0bmFybmhyd2NiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE1NDEyODMsImV4cCI6MjA3NzExNzI4M30.rg05a4k_uUJopohOHf3RGo5-RZAvVjq85cg1kra_tMw";
    const CLOUD_TABLE = 'homes';
    const EMAIL_WEBHOOK = ""; // optional: Zapier/Make/IFTTT webhook

    // ====== State ======
    const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    /** @type {Home[]} */ let HOMES = [];
    let MAP, LAYER, PREVIEW_MAP, PREVIEW_MARKER;

    const els = {
      map: document.getElementById('map'),
      list: document.getElementById('list'),
      search: document.getElementById('search'),
      chips: Array.from(document.querySelectorAll('.chip')),
      addBtn: document.getElementById('addHomeBtn'),
      addDialog: document.getElementById('addDialog'),
      name: document.getElementById('name'),
      address: document.getElementById('address'),
      postcode: document.getElementById('postcode'),
      houseNo: document.getElementById('houseNo'),
      teal: document.getElementById('teal'),
      lights: document.getElementById('lights'),
      music: document.getElementById('music'),
      animatronics: document.getElementById('animatronics'),
      notes: document.getElementById('notes'),
      saveBtn: document.getElementById('saveBtn'),
      geocodeBtn: document.getElementById('geocodeBtn'),
      previewMap: document.getElementById('previewMap'),
      errorMsg: document.getElementById('errorMsg'),
      pcSuggest: document.getElementById('pcSuggest'),
      countdown: document.getElementById('countdown'),
    };

    // ====== Init ======
    init();

    async function init(){
      await cloudLoad();
      initMap();
      render();
      fitAllMarkers();
      subscribeRealtime();
      wireUI();
      startCountdown();
    }

    async function cloudLoad(){
      const { data, error } = await supa.from(CLOUD_TABLE).select('*').order('updated_at',{ascending:false});
      HOMES = error ? [] : data.map(fromRow);
    }

    function initMap(){
      MAP = L.map('map', {scrollWheelZoom:true});
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution:'&copy; OpenStreetMap contributors' }).addTo(MAP);
      LAYER = L.layerGroup().addTo(MAP);
      MAP.setView([54.5,-3.4],5); // UK default; fitAllMarkers() will override when pins exist
    }

    function subscribeRealtime(){
      supa.channel('public:homes')
        .on('postgres_changes', { event:'*', schema:'public', table:CLOUD_TABLE }, payload => {
          const { eventType, new: n, old } = payload;
          if (eventType === 'INSERT' || eventType === 'UPDATE') {
            upsertLocal(fromRow(n));
          } else if (eventType === 'DELETE') {
            HOMES = HOMES.filter(h=>h.id!==old.id);
          }
          render(); fitAllMarkers();
        })
        .subscribe();
    }

    function wireUI(){
      els.addBtn.addEventListener('click', ()=> openAddDialog(null));
      els.search.addEventListener('input', debounce(render, 120));
      els.chips.forEach(c=> c.addEventListener('click', ()=>{ c.classList.toggle('active'); render(); }));

      // Postcode suggestions + preview
      els.postcode.addEventListener('input', debounce(showSuggestions, 280));
      document.addEventListener('click', (e)=>{ if (!els.pcSuggest.contains(e.target) && e.target!==els.postcode){ hideSuggestions(); }});
      els.geocodeBtn.addEventListener('click', onPreview);
      els.saveBtn.addEventListener('click', onSave);

      // Keyboard
      document.addEventListener('keydown', (e)=>{
        if ((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='k'){ e.preventDefault(); els.search.focus(); }
        if ((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='n'){ e.preventDefault(); openAddDialog(null); }
      });

      // Close dialog when clicking the backdrop
      els.addDialog.addEventListener('click', (e)=>{ if (e.target===els.addDialog) els.addDialog.close(); });
    }

    // ====== Rendering ======
    function markerIcon(color){ return L.divIcon({ className:'custom-pin', html:`<div style="width:18px;height:18px;border-radius:50%;background:${color};border:2px solid #0b0b0d;box-shadow:0 0 0 2px rgba(0,0,0,.2)"></div>`, iconSize:[18,18] }); }
    function colorFor(h){ return h.flags?.teal ? '#2fb1d9' : '#ff7a00'; }
    function normalisePostcode(s){ if(!s) return ''; const r=s.toUpperCase().replace(/\s+/g,''); return r.length<5 ? r : r.slice(0,-3)+' '+r.slice(-3); }
    function haystack(h){
      const pc = normalisePostcode(h.postcode||''); const pcT = pc.replace(/\s+/g,'');
      return [h.name||'', h.fullAddress||'', h.address||'', h.notes||'', h.houseNo||'', pc, pcT].join(' ').toLowerCase();
    }

    function render(){
      LAYER.clearLayers();

      const qRaw = (els.search.value||'').trim().toLowerCase();
      const qTight = qRaw.replace(/\s+/g,'');
      const activeFilters = new Set(els.chips.filter(c=>c.classList.contains('active')).map(c=>c.dataset.filter));

      const filtered = HOMES.filter(h=>{
        if (qRaw){
          const hay = haystack(h);
          if (!hay.includes(qRaw) && !hay.includes(qTight)) return false;
        }
        if (activeFilters.has('teal') && !h.flags?.teal) return false;
        if (activeFilters.has('lights') && !h.flags?.lights) return false;
        if (activeFilters.has('music') && !h.flags?.music) return false;
        if (activeFilters.has('animatronics') && !h.flags?.animatronics) return false;
        return true;
      });

      const bounds=[];
      filtered.forEach(h=>{
        if (isNum(h.lat) && isNum(h.lng)){
          const m = L.marker([h.lat,h.lng], { icon: markerIcon(colorFor(h)), draggable:true }).addTo(LAYER);
          m.bindPopup(`<strong>${esc(h.name||'Halloween House')}</strong><br><span class="muted">${esc(h.fullAddress || h.address || '')}</span><br>${h.flags?.teal?'<span class="badge teal">Teal pumpkin</span>':''}${h.notes?`<div style="margin-top:6px">${esc(h.notes)}</div>`:''}`);
          m.on('dragend', e=>{ const {lat,lng}=e.target.getLatLng(); h.lat=lat; h.lng=lng; h.updatedAt=Date.now(); persist(h,false); });
          bounds.push([h.lat,h.lng]);
        }
      });
      if (bounds.length){ try{ MAP.fitBounds(bounds,{padding:[40,40]}); }catch{} }

      els.list.innerHTML='';
      if (!filtered.length){ els.list.innerHTML = `<p class="muted">No homes match your search yet.</p>`; }
      else filtered
        .sort((a,b)=> (a.fullAddress||a.address||'').localeCompare(b.fullAddress||b.address||'')) 
        .forEach(h=> els.list.appendChild(row(h)));
    }

    function row(h){
      const el = document.createElement('div'); el.className='home';
      el.innerHTML = `
        <div class="row" style="flex-direction:column; gap:6px">
          ${h.flags?.teal?'<span class="badge teal">Teal pumpkin</span>':''}
        </div>
        <div>
          <div class="row" style="justify-content:space-between">
            <strong>${esc(h.name||'Halloween House')}</strong>
            <span class="muted">${esc(h.fullAddress || h.address || '')}</span>
          </div>
          <div class="kvs" style="margin:6px 0 8px">
            ${h.flags?.lights?'<span>üí° Lights</span>':''}
            ${h.flags?.music?'<span>üéµ Music</span>':''}
            ${h.flags?.animatronics?'<span>ü§ñ Animatronics</span>':''}
          </div>
          <div class="muted">${esc(h.notes||'')}</div>
          <div class="row" style="margin-top:8px; gap:10px; flex-wrap:wrap">
            <button class="btn small ghost" data-id="${h.id}" data-act="center">üìç Center</button>
          </div>
        </div>`;
      el.querySelector('[data-act="center"]').addEventListener('click', ()=>{ if (isNum(h.lat)&&isNum(h.lng)) MAP.setView([h.lat,h.lng], 18, {animate:true}); });
      return el;
    }

    // ====== Add dialog ======
    let editing = null; // public page = add only, but keep for safety
    function openAddDialog(existing){
      editing = existing?.id || null; els.errorMsg.style.display='none'; els.previewMap.style.display='none';
      els.houseNo.value = existing?.houseNo || '';
      els.postcode.value = existing?.postcode || '';
      els.address.value  = existing?.address  || '';
      els.name.value     = existing?.name||'';
      els.teal.checked   = !!existing?.flags?.teal;
      els.lights.checked = !!existing?.flags?.lights;
      els.music.checked  = !!existing?.flags?.music;
      els.animatronics.checked = !!existing?.flags?.animatronics;
      els.notes.value    = existing?.notes||'';
      els.addDialog.showModal();
      setTimeout(()=> initPreview(existing), 60);
      hideSuggestions();
    }

    function initPreview(existing){
      if (!PREVIEW_MAP){
        els.previewMap.style.display='block';
        PREVIEW_MAP = L.map('previewMap', {scrollWheelZoom:false});
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'&copy; OpenStreetMap'}).addTo(PREVIEW_MAP);
        PREVIEW_MAP.setView([54.5,-3.4],5);
      }
      if (existing && isNum(existing.lat) && isNum(existing.lng)){
        if (!PREVIEW_MARKER){ PREVIEW_MARKER = L.marker([existing.lat, existing.lng], {draggable:true}).addTo(PREVIEW_MAP); }
        else PREVIEW_MARKER.setLatLng([existing.lat, existing.lng]);
        PREVIEW_MAP.setView([existing.lat, existing.lng], 15);
      } else {
        if (PREVIEW_MARKER){ PREVIEW_MAP.removeLayer(PREVIEW_MARKER); PREVIEW_MARKER=null; }
        PREVIEW_MAP.setView([54.5,-3.4],5);
      }
    }

    async function onPreview(e){
      e.preventDefault(); els.errorMsg.style.display='none';
      try{
        const pos = await smartGeocode({ houseNo: els.houseNo.value, address: els.address.value, postcode: els.postcode.value });
        showPreviewAt(pos.lat,pos.lng);
      } catch {
        showError('Could not find that address. You can still save and drag the pin later.');
      }
    }

    async function onSave(e){
      e.preventDefault(); els.errorMsg.style.display='none';
      const isNew = !editing;
      const item = sanitizeHome({
        id: editing || cryptoId(),
        name: els.name.value.trim(),
        address: els.address.value.trim(),
        postcode: els.postcode.value.trim(),
        houseNo: els.houseNo.value.trim(),
        flags:{ teal:els.teal.checked, lights:els.lights.checked, music:els.music.checked, animatronics:els.animatronics.checked },
        notes: els.notes.value.trim(),
        updatedAt: Date.now()
      });
      item.fullAddress = buildFullAddress(item.houseNo, item.address, item.postcode) || item.address;

      if (PREVIEW_MARKER){ const ll = PREVIEW_MARKER.getLatLng(); item.lat=ll.lat; item.lng=ll.lng; }
      if (!isNum(item.lat) || !isNum(item.lng)){
        try{
          const pos = await smartGeocode({ houseNo: item.houseNo, address: item.address, postcode: item.postcode });
          item.lat = pos.lat; item.lng = pos.lng;
        }catch{/* leave undefined; user can drag later */}
      }

      try{
        await persist(item, true);
        els.addDialog.close();
        els.previewMap.style.display='none';
        fitAllMarkers();
        if (isNew && EMAIL_WEBHOOK){
          fetch(EMAIL_WEBHOOK, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ event:'home_added', home:item }) }).catch(()=>{});
        }
      }catch(err){ showError('Save failed. Check keys/table.'); console.error(err); }
    }

    // ====== Geocoding (UK-structured) & suggestions ======
    function splitAddress(s){
      const parts = (s || '').split(',').map(x => x.trim()).filter(Boolean);
      return { road: parts[0] || '', place: parts[1] || '' };
    }
    async function fetchGeo(params){
      const url = new URL('https://nominatim.openstreetmap.org/search');
      url.searchParams.set('format','jsonv2');
      url.searchParams.set('limit','1');
      url.searchParams.set('addressdetails','1');
      url.searchParams.set('countrycodes','gb');
      url.searchParams.set('accept-language','en-GB');
      // UK viewbox (SW lon,lat, NE lon,lat)
      url.searchParams.set('viewbox','-8.35,49.84,1.78,60.86');
      url.searchParams.set('bounded','1');
      for (const [k,v] of Object.entries(params)){ if (v!=null && v!=='') url.searchParams.set(k, v); }
      const res = await fetch(url.toString(), { headers:{'Accept':'application/json'} });
      if (!res.ok) throw new Error('lookup failed');
      const data = await res.json();
      if (!Array.isArray(data) || data.length===0) throw new Error('no results');
      return { lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lon) };
    }
    async function smartGeocode({ houseNo, address, postcode }){
      const pcRaw = (postcode || '').toUpperCase().replace(/\s+/g,'');
      const pc = pcRaw.length<5 ? pcRaw : pcRaw.slice(0,-3)+' '+pcRaw.slice(-3);
      const { road, place } = splitAddress(address || '');
      const street = [houseNo || '', road || ''].filter(Boolean).join(' ').trim();

      // 1) Structured street + place + postcode
      if (street || place || pc){
        try { return await fetchGeo({ street: street || undefined, city: place || undefined, postalcode: pc || undefined }); } catch {}
      }
      // 2) Postcode centroid
      if (pc){ try { return await fetchGeo({ postalcode: pc }); } catch {} }
      // 3) Bounded free-text
      const full = [houseNo, address, pc].filter(Boolean).join(', ');
      if (full){ try { return await fetchGeo({ q: full }); } catch {} }
      throw new Error('Geocoding failed');
    }

    async function showSuggestions(){
      const raw=(els.postcode.value||'').toUpperCase().replace(/\s+/g,'');
      if (raw.length<5){ hideSuggestions(); return; }
      const pc = raw.slice(0,-3)+' '+raw.slice(-3);
      els.postcode.value = pc;
      try{
        const u=new URL('https://nominatim.openstreetmap.org/search');
        u.searchParams.set('format','jsonv2'); u.searchParams.set('q',pc+' UK'); u.searchParams.set('limit','8'); u.searchParams.set('addressdetails','1'); u.searchParams.set('countrycodes','gb');
        const res=await fetch(u,{headers:{'Accept':'application/json'}}); if(!res.ok) throw 0;
        const data=await res.json();
        const list=[]; const seen=new Set();
        data.forEach(row=>{ const a=row.address||{}; const road=a.road||a.pedestrian||a.residential||''; const town=a.village||a.town||a.city||a.suburb||a.hamlet||a.county||''; if(road&&town){const s=`${road}, ${town}`; if(!seen.has(s)){seen.add(s); list.push(s);} }});
        if(!list.length){ hideSuggestions(); return; }
        els.pcSuggest.classList.remove('hidden');
        els.pcSuggest.innerHTML='<ul>'+list.slice(0,12).map(s=>`<li>${s}</li>`).join('')+'</ul>';
        els.pcSuggest.querySelectorAll('li').forEach(li=>li.addEventListener('click', async ()=>{
          els.address.value = li.textContent || '';
          hideSuggestions();
          try{
            const pos = await smartGeocode({ houseNo: els.houseNo.value, address: els.address.value, postcode: els.postcode.value });
            showPreviewAt(pos.lat,pos.lng);
          }catch{}
        }));
      }catch{ hideSuggestions(); }
    }
    function hideSuggestions(){ els.pcSuggest.classList.add('hidden'); els.pcSuggest.innerHTML=''; }

    function showPreviewAt(lat,lng){
      els.previewMap.style.display='block';
      if (!PREVIEW_MAP){
        PREVIEW_MAP = L.map('previewMap', {scrollWheelZoom:false});
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'&copy; OpenStreetMap'}).addTo(PREVIEW_MAP);
      }
      if (!PREVIEW_MARKER){ PREVIEW_MARKER=L.marker([lat,lng],{draggable:true}).addTo(PREVIEW_MAP); }
      else PREVIEW_MARKER.setLatLng([lat,lng]);
      PREVIEW_MAP.setView([lat,lng],16);
    }

    // ====== Persistence & mapping ======
    async function persist(h, rerender){
      upsertLocal(h);
      const { error } = await supa.from(CLOUD_TABLE).upsert([toRow(h)]);
      if (error) throw error;
      if (rerender) render();
    }
    function upsertLocal(h){ const i=HOMES.findIndex(x=>x.id===h.id); if(i>-1) HOMES[i]=h; else HOMES.push(h); }
    function toRow(h){ return { id:h.id, name:h.name, address:h.address, postcode:h.postcode, house_no:h.houseNo, full_address:h.fullAddress, lat:h.lat, lng:h.lng, candy:'Mixed', teal:h.flags?.teal, lights:h.flags?.lights, music:h.flags?.music, animatronics:h.flags?.animatronics, notes:h.notes, updated_at:new Date(h.updatedAt||Date.now()).toISOString() }; }
    function fromRow(r){ return sanitizeHome({ id:r.id, name:r.name, address:r.address, postcode:r.postcode, houseNo:r.house_no, fullAddress:r.full_address, lat:r.lat, lng:r.lng, candy:r.candy, flags:{ teal:!!r.teal, lights:!!r.lights, music:!!r.music, animatronics:!!r.animatronics }, notes:r.notes, updatedAt: Date.parse(r.updated_at||Date.now()) }); }

    // ====== Fit bounds ======
    function fitAllMarkers(){
      const pts = HOMES.filter(h=>isNum(h.lat)&&isNum(h.lng)).map(h=>[h.lat,h.lng]);
      if (pts.length){ try{ MAP.fitBounds(pts,{padding:[40,40]}); }catch{} }
    }

    // ====== Countdown to Oct 31 16:00 GMT ======
    function startCountdown(){
      function tick(){
        const y = new Date().getUTCFullYear();
        const target = new Date(Date.UTC(y, 9, 31, 16, 0, 0)); // Oct (9) 31 @ 16:00 UTC
        const now = new Date();
        let diff = target - now;
        if (diff <= 0){ els.countdown.textContent = "It's Halloween! üéÉ"; return; }
        const d = Math.floor(diff/86400000);
        diff %= 86400000;
        const h = Math.floor(diff/3600000);
        diff %= 3600000;
        const m = Math.floor(diff/60000);
        diff %= 60000;
        const s = Math.floor(diff/1000);
        els.countdown.textContent = `‚è≥ ${d}d ${h}h ${m}m ${s}s to Halloween (16:00 GMT)`;
      }
      tick(); setInterval(tick, 1000);
    }

    // ====== helpers ======
    function buildFullAddress(no, addr, pc){ return [no||'', addr||'', pc||''].filter(Boolean).join(', '); }
    function sanitizeHome(h){ return { id:h.id || cryptoId(), name:(h.name||'').slice(0,120), address:(h.address||'').slice(0,180), postcode:(h.postcode||'').slice(0,16), houseNo:(h.houseNo||'').slice(0,16), fullAddress:(h.fullAddress||'').slice(0,240), lat:isNum(h.lat)?+h.lat:undefined, lng:isNum(h.lng)?+h.lng:undefined, candy:h.candy||'Mixed', flags:{ teal:!!(h.flags&&h.flags.teal), lights:!!(h.flags&&h.flags.lights), music:!!(h.flags&&h.flags.music), animatronics:!!(h.flags&&h.flags.animatronics) }, notes:(h.notes||'').slice(0,500), updatedAt:Number(h.updatedAt||Date.now()) }; }
    function cryptoId(){ return [...crypto.getRandomValues(new Uint8Array(16))].map(b=>b.toString(16).padStart(2,'0')).join(''); }
    function debounce(fn,ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; }
    const esc = s => (s||'').replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]));
    const isNum = x => typeof x==='number' && !Number.isNaN(x);

  })();

  /**
   * @typedef Home
   * @property {string} id
   * @property {string} name
   * @property {string} address
   * @property {string} postcode
   * @property {string} houseNo
   * @property {string} fullAddress
   * @property {number=} lat
   * @property {number=} lng
   * @property {string} candy
   * @property {{teal:boolean, lights:boolean, music:boolean, animatronics:boolean}} flags
   * @property {string} notes
   * @property {number} updatedAt
   */
  </script>
</body>
</html>
